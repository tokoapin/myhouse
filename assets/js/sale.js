// Generated by CoffeeScript 1.4.0

$(function() {
  $.extend({
    getUrlVars: function() {
      var hash, hashes, i, vars;
      vars = [];
      hash = void 0;
      hashes = window.location.href.slice(window.location.href.indexOf("?") + 1).split("&");
      i = 0;
      while (i < hashes.length) {
        hash = hashes[i].split("=");
        vars.push(hash[0]);
        vars[hash[0]] = decodeURIComponent(hash[1]);
        i++;
      }
      return vars;
    },
    getUrlVar: function(name) {
      return $.getUrlVars()[name];
    }
  });
  $("#submit_date").datepicker({
    dateFormat: "yy-mm-dd"
  });
  if ($("#sale_form").length > 0) {
    $("#sale_form").validate({
      rules: {
        title: "required",
        agree: "required"
      },
      messages: {
        title: "Please enter title",
        agree: "Please accept our policy"
      }
    });
  }
  return $(document).on("click", ".manage_house", function(e) {
    var source, template, uid;
    source = $("#manage-template").html();
    template = Handlebars.compile(source);
    uid = $(this).data("uid");
    return $.ajax({
      url: "/sale/item/" + uid,
      dataType: "json",
      type: "GET",
      success: function(response) {
        var html;
        if (response.success_text) {
          response.item.is_submit = +response.item.is_submit;
          response.item.is_owner = +response.item.is_owner;
          html = template(response.item);
          return $("#manage_house").html(html);
        }
      }
    });
  }).on("click", ".setting", function(e) {
    var data, form_info, key, message, mode, uid, value;
    e.preventDefault();
    mode = $(this).data("mode") || "";
    form_info = $("#setting_form").serializeObject();
    uid = $(this).data("uid") || "";
    data = {};
    message = "";
    switch (mode) {
      case "reservation":
      case "deal":
        $("#reservation, #deal").hide();
        return $("#" + mode).show();
      case "update_reservation":
      case "update_deal":
        if (mode === "update_reservation") {
          message = "已預約/續約成功";
        }
        if (mode === "update_deal") {
          message = "設定已成交";
        }
        return $.ajax({
          url: "/sale/setting/" + uid,
          dataType: "json",
          data: $.extend(form_info, {
            mode: mode
          }),
          type: "POST",
          success: function(response) {
            if (response.success_text) {
              return alert(message);
            }
          }
        });
      case "open":
      case "close":
        key = $(this).data("key") || "";
        value = $(this).data("value") || "";
        return $.ajax({
          url: "/sale/setting/" + uid,
          dataType: "json",
          data: {
            key: key,
            value: value,
            mode: mode
          },
          type: "POST",
          success: function(response) {
            if (response.success_text) {
              alert("設定完成，重新整理網頁");
              return window.location.reload();
            }
          }
        });
      case "delete":
        if (!confirm("確定要刪除此銷售物件?")) {
          return true;
        }
        return $.ajax({
          url: "/sale/delete/" + uid,
          dataType: "json",
          type: "GET",
          success: function(response) {
            if (response.success_text) {
              alert("刪除完成，重新整理網頁");
              return window.location.reload();
            }
          }
        });
    }
  }).on("shown", "#manage_house", function() {
    return $("#submit_date").datepicker({
      dateFormat: "yy-mm-dd"
    });
  });
});
